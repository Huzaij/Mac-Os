name: RustDesk Screenshot

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshot:
    runs-on: windows-latest
    timeout-minutes: 1440  # 24 hours

    steps:
      - name: Download RustDesk
        run: |
          $rustdeskUrl = "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.exe"
          $rustdeskPath = "$env:TEMP\rustdesk.exe"
          Invoke-WebRequest -Uri $rustdeskUrl -OutFile $rustdeskPath
          echo "RUSTDESK_PATH=$rustdeskPath" >> $env:GITHUB_ENV

      - name: Download NirCmd
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $nircmdZip = "$env:TEMP\nircmd.zip"
          $nircmdDir = "$env:TEMP\nircmd"
          
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdZip
          Expand-Archive -Path $nircmdZip -DestinationPath $nircmdDir -Force
          echo "NIRCMD_PATH=$nircmdDir\nircmd.exe" >> $env:GITHUB_ENV

      - name: Start RustDesk and take screenshots
        run: |
          # Start RustDesk
          Start-Process -FilePath $env:RUSTDESK_PATH
          Write-Host "RustDesk started, waiting for initialization..."
          Start-Sleep -Seconds 10

          # Take 3 screenshots quickly with delays
          for ($i = 1; $i -le 3; $i++) {
              Write-Host "Taking screenshot $i..."
              & $env:NIRCMD_PATH savescreenshot "$env:TEMP\screenshot_$i.png"
              Start-Sleep -Seconds 2
          }

          Write-Host "All screenshots completed"

      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-screenshots
          path: ${{ env.TEMP }}\screenshot_*.png
          retention-days: 1

      - name: Keep workflow running 24/7
        run: |
          Write-Host "=== RustDesk Screenshot Workflow ==="
          Write-Host "RustDesk is running in the background"
          Write-Host "Screenshots have been uploaded as artifacts"
          Write-Host "Workflow will run for 24 hours or until manually cancelled"
          Write-Host "====================================="
          
          # Keep the workflow alive
          $startTime = Get-Date
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 24) {
              Write-Host "[$(Get-Date)] RustDesk still running... (Ctrl+C in workflow to terminate)"
              Start-Sleep -Seconds 300  # Sleep for 5 minutes
          }
          
          Write-Host "24-hour limit reached, workflow completed"
